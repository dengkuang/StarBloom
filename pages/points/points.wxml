<!-- ç§¯åˆ†ä¸­å¿ƒé¡µé¢ -->
<scroll-view class="container" scroll-y="true" enhanced="true" show-scrollbar="false" bindscrolltolower="onReachBottom">
  
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header-section">
    <!-- å­©å­é€‰æ‹©å™¨ -->
    <view class="child-selector" wx:if="{{childrenList.length > 0}}">
      <picker range="{{childrenList}}" range-key="name" value="{{currentChildIndex}}" bindchange="onChildChange">
        <view class="picker-content">
          <image class="child-avatar-header" src="{{currentChild.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="child-info-header">
            <text class="child-name-header">{{currentChild.name}}</text>
            <text class="child-points-header">å½“å‰ç§¯åˆ†: {{currentChild.totalPoints || 0}}</text>
          </view>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- ç§¯åˆ†ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="points-overview" wx:if="{{currentChild}}">
      <view class="overview-card main-card">
        <view class="main-points">
          <text class="points-number">{{pointStats.totalPoints || 0}}</text>
          <text class="points-label">æ€»ç§¯åˆ†</text>
        </view>
        <view class="points-trend">
          <view class="trend-item">
            <text class="trend-label">ä»Šæ—¥</text>
            <text class="trend-value positive">+{{pointStats.todayPoints || 0}}</text>
          </view>
          <view class="trend-item">
            <text class="trend-label">æœ¬å‘¨</text>
            <text class="trend-value positive">+{{pointStats.weekPoints || 0}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section" wx:if="{{currentChild}}">
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-icon earn">ğŸ“ˆ</view>
        <view class="stat-info">
          <text class="stat-value">{{pointStats.totalEarnedPoints || 0}}</text>
          <text class="stat-label">ç´¯è®¡è·å¾—</text>
        </view>
      </view>
      <view class="stat-card">
        <view class="stat-icon consume">ğŸ“‰</view>
        <view class="stat-info">
          <text class="stat-value">{{pointStats.totalConsumedPoints || 0}}</text>
          <text class="stat-label">ç´¯è®¡æ¶ˆè´¹</text>
        </view>
      </view>
      <view class="stat-card">
        <view class="stat-icon tasks">âœ…</view>
        <view class="stat-info">
          <text class="stat-value">{{pointStats.tasksCompleted || 0}}</text>
          <text class="stat-label">å®Œæˆä»»åŠ¡</text>
        </view>
      </view>
      <view class="stat-card">
        <view class="stat-icon month">ğŸ“…</view>
        <view class="stat-info">
          <text class="stat-value">{{pointStats.monthPoints || 0}}</text>
          <text class="stat-label">æœ¬æœˆè·å¾—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section" wx:if="{{currentChild}}">
    <view class="filter-tabs">
      <view class="filter-tab {{filterType === 'all' ? 'active' : ''}}" bindtap="onFilterTypeChange" data-value="all">
        <text>å…¨éƒ¨</text>
      </view>
      <view class="filter-tab {{filterType === 'earn' ? 'active' : ''}}" bindtap="onFilterTypeChange" data-value="earn">
        <text>è·å¾—</text>
      </view>
      <view class="filter-tab {{filterType === 'consume' ? 'active' : ''}}" bindtap="onFilterTypeChange" data-value="consume">
        <text>æ¶ˆè´¹</text>
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†è®°å½•åˆ—è¡¨ -->
  <view class="records-section" wx:if="{{currentChild}}">
    <view class="section-header">
      <text class="section-title">ç§¯åˆ†è®°å½•</text>
      <view class="header-actions">
        <button class="action-btn add" bindtap="showAdjustPointsModal" data-type="add">å¢åŠ </button>
        <button class="action-btn subtract" bindtap="showAdjustPointsModal" data-type="subtract">æ‰£å‡</button>
      </view>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="records-list" wx:if="{{pointRecords.length > 0}}">
      <view class="record-item" wx:for="{{pointRecords}}" wx:key="_id">
        <view class="record-icon {{getRecordTypeColor(item)}}">
          <text wx:if="{{item.changeType === 'earn'}}">ğŸ’°</text>
          <text wx:elif="{{item.changeType === 'consume'}}">ğŸ</text>
          <text wx:elif="{{item.changeType === 'adjustment_add'}}">â•</text>
          <text wx:elif="{{item.changeType === 'adjustment_subtract'}}">â–</text>
          <text wx:else>ğŸ“</text>
        </view>
        <view class="record-content">
          <view class="record-main">
            <text class="record-title">{{getRecordTypeText(item)}}</text>
            <text class="record-desc" wx:if="{{item.description}}">{{item.description}}</text>
            <text class="record-reason" wx:if="{{item.reason}}">åŸå› : {{item.reason}}</text>
          </view>
          <view class="record-right">
            <text class="record-points {{item.changeType === 'earn' || item.changeType === 'adjustment_add' ? 'positive' : 'negative'}}">
              {{item.changeType === 'earn' || item.changeType === 'adjustment_add' ? '+' : ''}}{{item.points}}
            </text>
            <text class="record-time">{{formatDate(item.createdAt)}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-records" wx:else>
      <view class="empty-icon">ğŸ“Š</view>
      <text class="empty-text">æš‚æ— ç§¯åˆ†è®°å½•</text>
      <text class="empty-desc">å®Œæˆä»»åŠ¡æˆ–æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†åä¼šæ˜¾ç¤ºè®°å½•</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{pointRecords.length > 0}}">
      <text wx:if="{{loadingMore}}">åŠ è½½ä¸­...</text>
      <text wx:elif="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
      <text wx:else>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ - æ— å­©å­ -->
  <view class="empty-child-state" wx:if="{{childrenList.length === 0}}">
    <view class="empty-icon-large">ğŸ‘¶</view>
    <text class="empty-title">è¿˜æ²¡æœ‰æ·»åŠ å­©å­</text>
    <text class="empty-desc">æ·»åŠ å­©å­ä¿¡æ¯åæ‰èƒ½æŸ¥çœ‹ç§¯åˆ†è®°å½•</text>
    <button class="add-child-btn" bindtap="navigateToChild">æ·»åŠ å­©å­</button>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>
</scroll-view>

<!-- è°ƒæ•´ç§¯åˆ†å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showAdjustModal}}" bindtap="hideAdjustPointsModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">{{adjustType === 'add' ? 'å¢åŠ ç§¯åˆ†' : 'æ‰£å‡ç§¯åˆ†'}}</text>
      <view class="modal-close" bindtap="hideAdjustPointsModal">âœ•</view>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">ç§¯åˆ†æ•°é‡</text>
        <input class="input-field" type="number" placeholder="è¯·è¾“å…¥ç§¯åˆ†æ•°é‡" value="{{adjustPoints}}" bindinput="onAdjustPointsInput" />
      </view>
      
      <view class="input-group">
        <text class="input-label">è°ƒæ•´åŸå› </text>
        <textarea class="textarea-field" placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› " value="{{adjustReason}}" bindinput="onAdjustReasonInput" maxlength="100"></textarea>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="hideAdjustPointsModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm {{adjustType}}" bindtap="confirmAdjustPoints">ç¡®è®¤{{adjustType === 'add' ? 'å¢åŠ ' : 'æ‰£å‡'}}</button>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{loading && !pointRecords.length}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>