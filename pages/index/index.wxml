<!-- 家长管理首页 - 重构版 -->
<scroll-view class="container" scroll-y="true" enhanced="true" show-scrollbar="false">
  
  <!-- 头部区域 -->
  <view class="header-section">
    <!-- 用户信息和日期 -->
    <view class="user-header">
      <view class="user-info">
        <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="user-details">
          <text class="welcome-text">你好，{{userInfo.nickName || '家长'}}！</text>
          <text class="date-text">{{currentDate}}</text>
        </view>
      </view>
      <view class="notification-icon" bindtap="onNotificationTap">
        <text class="icon">🔔</text>
        <view class="badge" wx:if="{{unreadCount > 0}}">{{unreadCount}}</view>
      </view>
    </view>

    <!-- 孩子管理区域 -->
    <view class="child-management" wx:if="{{childrenList.length > 0}}">
      <text class="child-count">共 {{childrenList.length}} 个孩子</text>
      <view class="child-actions">
        <button class="child-action-btn" bindtap="onAddChild">添加孩子</button>
      </view>
    </view>

    <!-- 孩子选择器 -->
    <view class="child-selector-wrapper" wx:if="{{childrenList.length > 0}}">
      <child-selector
        childrenList="{{childrenList}}"
        currentChild="{{currentChild}}"
        selectedIndex="{{currentChildIndex}}"
        showPoints="{{true}}"
        bind:change="onChildSelectorChange"
        bind:toggle="onChildSelectorToggle"
      ></child-selector>
    </view>

    <!-- 当前孩子统计卡片 -->
    <view class="current-child-stats" wx:if="{{currentChild}}">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{currentChild.totalPoints || 0}}</text>
          <text class="stat-label">总积分</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{todayCompletedTasks || 0}}</text>
          <text class="stat-label">今日完成</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{todayEarnedPoints || 0}}</text>
          <text class="stat-label">今日获得</text>
        </view>
      </view>
    </view>
  </view>

  

  <!-- 任务管理模块 -->
  <view class="section-container" wx:if="{{childrenList.length > 0}}">
    <view class="section-header">
      <text class="section-title">任务管理</text>
      <button class="add-btn" bindtap="onAddTask" style="position: relative; left: 182rpx; top: 0rpx">添加任务</button>
    </view>
    
    <view class="task-list">
    <task-item 
        wx:for="{{Tasks}}" 
        wx:key="_id" 
        task="{{item}}"
        show-actions="{{true}}"
        bind:complete="onTaskComplete"
      ></task-item>
    </view>
  </view>

  <!-- 奖励管理模块 -->
  <view class="section-container" wx:if="{{childrenList.length > 0}}">
    <view class="section-header">
      <text class="section-title">奖励管理</text>
      <button class="add-btn" bindtap="onAddReward" style="position: relative; left: 182rpx; top: 0rpx">添加奖励</button>
    </view>
    
    <view class="reward-list">
      <block wx:for="{{Rewards}}" wx:key="_id">
        <reward-item 
          reward="{{item}}" 
          bind:exchange="onExchangeReward"
          bind:edit="onEditReward"
          bind:delete="onDeleteReward"
        ></reward-item>
      </block>
    </view>
  </view>

  <!-- 空状态 - 无孩子时显示 -->
  <view class="empty-child-state" wx:if="{{childrenList.length === 0}}">
    <image class="empty-icon" src="/images/empty-child.png" mode="aspectFit"></image>
    <text class="empty-title">还没有添加孩子</text>
    <text class="empty-desc">添加孩子信息，开始积分奖励管理</text>
    <button class="add-child-btn-main" bindtap="onAddChild">添加孩子</button>
  </view>

  <!-- 底部安全区域 -->
  <view class="safe-area-bottom"></view>
</scroll-view>

<!-- 加载状态 -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 错误提示 -->
<view class="error-overlay" wx:if="{{error}}">
  <view class="error-content">
    <text class="error-text">{{error}}</text>
    <button class="retry-button" bindtap="onRetry">重试</button>
  </view>
</view>