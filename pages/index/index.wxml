<!-- å®¶é•¿ç®¡ç†é¦–é¡µ - é‡æ„ç‰ˆ -->
<scroll-view class="container" scroll-y="true" enhanced="true" show-scrollbar="false">
  
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header-section">
    <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ—¥æœŸ -->
    <view class="user-header">
      <view class="user-info">
        <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="user-details">
          <text class="welcome-text">ä½ å¥½ï¼Œ{{userInfo.nickName || 'å®¶é•¿'}}ï¼</text>
          <text class="date-text">{{currentDate}}</text>
        </view>
      </view>
      <view class="notification-icon" bindtap="onNotificationTap">
        <text class="icon">ğŸ””</text>
        <view class="badge" wx:if="{{unreadCount > 0}}">{{unreadCount}}</view>
      </view>
    </view>

    <!-- å­©å­ç®¡ç†åŒºåŸŸ -->
    <view class="child-management" wx:if="{{childrenList.length > 0}}">
      <text class="child-count">å…± {{childrenList.length}} ä¸ªå­©å­</text>
      <view class="child-actions">
        <button class="child-action-btn" bindtap="onAddChild">æ·»åŠ å­©å­</button>
      </view>
    </view>

    <!-- å­©å­é€‰æ‹©å™¨ -->
    <view class="child-selector-wrapper" wx:if="{{childrenList.length > 0}}">
      <child-selector
        childrenList="{{childrenList}}"
        currentChild="{{currentChild}}"
        selectedIndex="{{currentChildIndex}}"
        showPoints="{{true}}"
        bind:change="onChildSelectorChange"
        bind:toggle="onChildSelectorToggle"
      ></child-selector>
    </view>

    <!-- å½“å‰å­©å­ç»Ÿè®¡å¡ç‰‡ -->
    <view class="current-child-stats" wx:if="{{currentChild}}">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{currentChild.totalPoints || 0}}</text>
          <text class="stat-label">æ€»ç§¯åˆ†</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{todayCompletedTasks || 0}}</text>
          <text class="stat-label">ä»Šæ—¥å®Œæˆ</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{todayEarnedPoints || 0}}</text>
          <text class="stat-label">ä»Šæ—¥è·å¾—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä»Šæ—¥ä»»åŠ¡æƒ…å†µ -->
  <view class="section today-tasks" wx:if="{{currentChild}}">
    <view class="section-header">
      <text class="section-title">ğŸ“‹ ä»Šæ—¥ä»»åŠ¡</text>
      <text class="section-more" bindtap="navigateToTasks">ç®¡ç†</text>
    </view>
    
    <!-- ä»»åŠ¡è¿›åº¦æ¦‚è§ˆ -->
    <view class="task-overview">
      <view class="progress-circle">
        <view class="circle-bg">
          <view class="circle-fill" style="transform: rotate({{todayTaskProgress * 3.6}}deg)"></view>
          <view class="circle-inner">
            <text class="progress-text">{{Math.round(todayTaskProgress)}}%</text>
          </view>
        </view>
      </view>
      <view class="progress-info">
        <text class="progress-title">ä»Šæ—¥å®Œæˆåº¦</text>
        <text class="progress-desc">{{todayCompletedTasks}}/{{todayTotalTasks}} ä¸ªä»»åŠ¡</text>
        <text class="progress-points">å·²è·å¾— {{todayEarnedPoints}} ç§¯åˆ†</text>
      </view>
    </view>

    <!-- ä»Šæ—¥ä»»åŠ¡åˆ—è¡¨ -->
    <view class="today-task-list" wx:if="{{todayTasks.length > 0}}">
      <task-item 
        wx:for="{{todayTasks.slice(0, 3)}}" 
        wx:key="_id" 
        task="{{item}}"
        show-actions="{{item.status !== 'completed'}}"
        bind:complete="onTaskComplete"
      ></task-item>
      <view class="view-more" wx:if="{{todayTasks.length > 3}}" bindtap="navigateToTasks">
        <text>æŸ¥çœ‹æ›´å¤šä»»åŠ¡ ({{todayTasks.length - 3}})</text>
      </view>
    </view>

    <view class="empty-tasks" wx:else>
      <text class="empty-text">ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’ä»»åŠ¡</text>
      <button class="add-task-btn" bindtap="onAddTask">æ·»åŠ ä»»åŠ¡</button>
    </view>
  </view>

  <!-- æŒ‘æˆ˜ä»»åŠ¡è¿›åº¦ -->
  <view class="section challenge-tasks" wx:if="{{currentChild && challengeTasks.length > 0}}">
    <view class="section-header">
      <text class="section-title">ğŸ† æŒ‘æˆ˜ä»»åŠ¡</text>
      <text class="section-more" bindtap="navigateToTasks">æŸ¥çœ‹å…¨éƒ¨</text>
    </view>
    
    <view class="challenge-list">
      <view class="challenge-item" wx:for="{{challengeTasks}}" wx:key="_id">
        <view class="challenge-info">
          <text class="challenge-name">{{item.name}}</text>
          <text class="challenge-desc">{{item.description}}</text>
          <view class="challenge-reward">
            <text class="reward-points">å¥–åŠ±: {{item.points}}ç§¯åˆ†</text>
            <text class="challenge-deadline" wx:if="{{item.deadline}}">æˆªæ­¢: {{item.deadline}}</text>
          </view>
        </view>
        <view class="challenge-progress">
          <view class="progress-bar-small">
            <view class="progress-fill-small" style="width: {{item.progress || 0}}%"></view>
          </view>
          <text class="progress-percent-small">{{item.progress || 0}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¥–åŠ±ç®¡ç† -->
  <view class="section rewards-section" wx:if="{{currentChild}}">
    <view class="section-header">
      <text class="section-title">ğŸ å¥–åŠ±å•†åº—</text>
      <text class="section-more" bindtap="navigateToRewards">ç®¡ç†</text>
    </view>
    
    <!-- å¯å…‘æ¢å¥–åŠ± -->
    <view class="available-rewards" wx:if="{{availableRewards.length > 0}}">
      <text class="subsection-title">å¯å…‘æ¢å¥–åŠ±</text>
      <scroll-view class="reward-scroll" scroll-x="true" show-scrollbar="false">
        <view class="reward-horizontal-list">
          <view class="reward-card" wx:for="{{availableRewards.slice(0, 5)}}" wx:key="_id" bindtap="onRewardTap" data-reward="{{item}}">
            <image class="reward-image" src="{{item.icon || '/images/default-reward.png'}}" mode="aspectFill"></image>
            <text class="reward-name-small">{{item.name}}</text>
            <text class="reward-points-small">{{item.points}}ç§¯åˆ†</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- çƒ­é—¨å¥–åŠ± -->
    <view class="popular-rewards" wx:if="{{popularRewards.length > 0}}">
      <text class="subsection-title">çƒ­é—¨å¥–åŠ±</text>
      <view class="reward-grid">
        <view class="reward-grid-item" wx:for="{{popularRewards.slice(0, 4)}}" wx:key="_id" bindtap="onRewardTap" data-reward="{{item}}">
          <image class="reward-icon-small" src="{{item.icon || '/images/default-reward.png'}}" mode="aspectFill"></image>
          <view class="reward-info-small">
            <text class="reward-name-grid">{{item.name}}</text>
            <text class="reward-points-grid">{{item.points}}ç§¯åˆ†</text>
          </view>
          <view class="exchange-status {{item.points <= (currentChild.totalPoints || 0) ? 'can-exchange' : 'cannot-exchange'}}">
            <text>{{item.points <= (currentChild.totalPoints || 0) ? 'å¯å…‘æ¢' : 'ç§¯åˆ†ä¸è¶³'}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œ -->
  <view class="section quick-actions">
    <view class="section-header">
      <text class="section-title">âš¡ å¿«æ·æ“ä½œ</text>
    </view>
    
    <view class="action-grid">
      <view class="action-card" bindtap="onAddTask">
        <view class="action-icon">â•</view>
        <text class="action-text">æ·»åŠ ä»»åŠ¡</text>
      </view>
      <view class="action-card" bindtap="onAddReward">
        <view class="action-icon">ğŸ</view>
        <text class="action-text">æ·»åŠ å¥–åŠ±</text>
      </view>
      <view class="action-card" bindtap="navigateToAnalysis">
        <view class="action-icon">ğŸ“Š</view>
        <text class="action-text">æ•°æ®åˆ†æ</text>
      </view>
      <view class="action-card" bindtap="navigateToSettings">
        <view class="action-icon">âš™ï¸</view>
        <text class="action-text">è®¾ç½®</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ - æ— å­©å­æ—¶æ˜¾ç¤º -->
  <view class="empty-child-state" wx:if="{{childrenList.length === 0}}">
    <image class="empty-icon" src="/images/empty-child.png" mode="aspectFit"></image>
    <text class="empty-title">è¿˜æ²¡æœ‰æ·»åŠ å­©å­</text>
    <text class="empty-desc">æ·»åŠ å­©å­ä¿¡æ¯ï¼Œå¼€å§‹ç§¯åˆ†å¥–åŠ±ç®¡ç†</text>
    <button class="add-child-btn-main" bindtap="onAddChild">æ·»åŠ å­©å­</button>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>
</scroll-view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- é”™è¯¯æç¤º -->
<view class="error-overlay" wx:if="{{error}}">
  <view class="error-content">
    <text class="error-text">{{error}}</text>
    <button class="retry-button" bindtap="onRetry">é‡è¯•</button>
  </view>
</view>