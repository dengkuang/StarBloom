<!-- é¢„è®¾æ¨¡æ¿é¡µé¢ -->
<scroll-view class="container" scroll-y="true" enhanced="true" show-scrollbar="false" bindscrolltolower="onReachBottom">
  
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header-section">
    <!-- é¡µé¢æ ‡é¢˜å’Œæè¿° -->
    <view class="page-header">
      <text class="page-title">é¢„è®¾æ¨¡æ¿</text>
      <text class="page-desc">ç²¾é€‰ä¼˜è´¨æ¨¡æ¿ï¼Œå¿«é€Ÿå¼€å§‹ç§¯åˆ†ç®¡ç†</text>
    </view>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="stats-overview">
      <view class="stat-item">
        <text class="stat-number">{{taskTemplateCount || 0}}</text>
        <text class="stat-label">ä»»åŠ¡æ¨¡æ¿</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{rewardTemplateCount || 0}}</text>
        <text class="stat-label">å¥–åŠ±æ¨¡æ¿</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{packageCount || 0}}</text>
        <text class="stat-label">æ¨¡æ¿åŒ…</text>
      </view>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œåŒºåŸŸ -->
  <view class="quick-actions-section">
    <view class="section-title">
      <text class="title-text">å¿«æ·æ“ä½œ</text>
    </view>
    <view class="action-grid">
      <view class="action-card" bindtap="navigateToManagement">
        <view class="action-icon">âš™ï¸</view>
        <text class="action-title">æ¨¡æ¿ç®¡ç†</text>
        <text class="action-desc">ç®¡ç†å’Œç¼–è¾‘æ¨¡æ¿</text>
      </view>
      <view class="action-card" bindtap="navigateToEditor">
        <view class="action-icon">âœï¸</view>
        <text class="action-title">åˆ›å»ºæ¨¡æ¿</text>
        <text class="action-desc">è‡ªå®šä¹‰æ–°æ¨¡æ¿</text>
      </view>
      <view class="action-card" bindtap="showImportModal">
        <view class="action-icon">ğŸ“¥</view>
        <text class="action-title">å¯¼å…¥æ¨¡æ¿</text>
        <text class="action-desc">ä»æ–‡ä»¶å¯¼å…¥</text>
      </view>
      <view class="action-card" bindtap="showExportModal">
        <view class="action-icon">ğŸ“¤</view>
        <text class="action-title">å¯¼å‡ºæ¨¡æ¿</text>
        <text class="action-desc">å¤‡ä»½åˆ°æ–‡ä»¶</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-section">
    <view class="tab-bar">
      <view class="tab {{activeTab === 'task' ? 'active' : ''}}" bindtap="onTabChange" data-tab="task">
        <view class="tab-icon">ğŸ“‹</view>
        <text class="tab-text">ä»»åŠ¡æ¨¡æ¿</text>
        <view class="tab-badge" wx:if="{{taskTemplates.length > 0}}">{{taskTemplates.length}}</view>
      </view>
      <view class="tab {{activeTab === 'reward' ? 'active' : ''}}" bindtap="onTabChange" data-tab="reward">
        <view class="tab-icon">ğŸ</view>
        <text class="tab-text">å¥–åŠ±æ¨¡æ¿</text>
        <view class="tab-badge" wx:if="{{rewardTemplates.length > 0}}">{{rewardTemplates.length}}</view>
      </view>
      <view class="tab {{activeTab === 'package' ? 'active' : ''}}" bindtap="onTabChange" data-tab="package">
        <view class="tab-icon">ğŸ“¦</view>
        <text class="tab-text">æ¨¡æ¿åŒ…</text>
        <view class="tab-badge" wx:if="{{packageGroups.length > 0}}">{{packageGroups.length}}</view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section" wx:if="{{activeTab !== 'package'}}">
    <scroll-view class="filter-scroll" scroll-x="true" show-scrollbar="false">
      <view class="filter-list">
        <view class="filter-item {{ageFilter === '' ? 'active' : ''}}" bindtap="onAgeFilterChange" data-age="">
          <text>å…¨éƒ¨å¹´é¾„</text>
        </view>
        <view class="filter-item {{ageFilter === '3-6' ? 'active' : ''}}" bindtap="onAgeFilterChange" data-age="3-6">
          <text>3-6å²</text>
        </view>
        <view class="filter-item {{ageFilter === '6-9' ? 'active' : ''}}" bindtap="onAgeFilterChange" data-age="6-9">
          <text>6-9å²</text>
        </view>
        <view class="filter-item {{ageFilter === '9-12' ? 'active' : ''}}" bindtap="onAgeFilterChange" data-age="9-12">
          <text>9-12å²</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-section">
    
    <!-- ä»»åŠ¡æ¨¡æ¿åˆ—è¡¨ -->
    <view class="template-list" wx:if="{{activeTab === 'task'}}">
      <view wx:if="{{filteredTaskTemplates.length > 0}}">
        <view class="template-card-modern" wx:for="{{filteredTaskTemplates}}" wx:key="id" wx:for-index="index">
          <view class="card-header">
            <view class="template-icon task-icon">ğŸ“‹</view>
            <view class="template-info">
              <text class="template-name">{{item.name}}</text>
              <text class="template-category">{{item.category || 'æ—¥å¸¸ä»»åŠ¡'}}</text>
            </view>
            <view class="template-points">
              <text class="points-value">{{item.points}}</text>
              <text class="points-unit">ç§¯åˆ†</text>
            </view>
          </view>
          
          <view class="card-body">
            <text class="template-description">{{item.description}}</text>
            <view class="template-tags">
              <text class="tag age-tag">{{getAgeGroupText(item.ageGroup)}}</text>
              <text class="tag difficulty-tag">{{getDifficultyText(item.difficulty)}}</text>
            </view>
          </view>
          
          <view class="card-actions">
            <button class="action-btn preview-btn" bindtap="onPreviewTemplate" data-template="{{item}}" data-index="{{index}}">
              <text class="btn-icon">ğŸ‘</text>
              <text>é¢„è§ˆ</text>
            </button>
            <button class="action-btn apply-btn" bindtap="onApplyTemplate" data-template="{{item}}" data-type="task">
              <text class="btn-icon">âœ“</text>
              <text>åº”ç”¨</text>
            </button>
          </view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:else>
        <view class="empty-icon">ğŸ“‹</view>
        <text class="empty-title">æš‚æ— ä»»åŠ¡æ¨¡æ¿</text>
        <text class="empty-desc">{{ageFilter ? 'å½“å‰å¹´é¾„æ®µæš‚æ— æ¨¡æ¿' : 'è¿˜æ²¡æœ‰é¢„è®¾çš„ä»»åŠ¡æ¨¡æ¿'}}</text>
        <button class="empty-action-btn" bindtap="navigateToEditor">åˆ›å»ºæ¨¡æ¿</button>
      </view>
    </view>

    <!-- å¥–åŠ±æ¨¡æ¿åˆ—è¡¨ -->
    <view class="template-list" wx:if="{{activeTab === 'reward'}}">
      <view wx:if="{{filteredRewardTemplates.length > 0}}">
        <view class="template-card-modern" wx:for="{{filteredRewardTemplates}}" wx:key="id" wx:for-index="index">
          <view class="card-header">
            <view class="template-icon reward-icon">ğŸ</view>
            <view class="template-info">
              <text class="template-name">{{item.name}}</text>
              <text class="template-category">{{item.category || 'å¥–åŠ±'}}</text>
            </view>
            <view class="template-points">
              <text class="points-value">{{item.pointsRequired}}</text>
              <text class="points-unit">ç§¯åˆ†</text>
            </view>
          </view>
          
          <view class="card-body">
            <text class="template-description">{{item.description}}</text>
            <view class="template-tags">
              <text class="tag age-tag">{{getAgeGroupText(item.ageGroup)}}</text>
              <text class="tag type-tag">{{getRewardTypeText(item.type)}}</text>
            </view>
          </view>
          
          <view class="card-actions">
            <button class="action-btn preview-btn" bindtap="onPreviewTemplate" data-template="{{item}}" data-index="{{index}}">
              <text class="btn-icon">ğŸ‘</text>
              <text>é¢„è§ˆ</text>
            </button>
            <button class="action-btn apply-btn" bindtap="onApplyTemplate" data-template="{{item}}" data-type="reward">
              <text class="btn-icon">âœ“</text>
              <text>åº”ç”¨</text>
            </button>
          </view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:else>
        <view class="empty-icon">ğŸ</view>
        <text class="empty-title">æš‚æ— å¥–åŠ±æ¨¡æ¿</text>
        <text class="empty-desc">{{ageFilter ? 'å½“å‰å¹´é¾„æ®µæš‚æ— æ¨¡æ¿' : 'è¿˜æ²¡æœ‰é¢„è®¾çš„å¥–åŠ±æ¨¡æ¿'}}</text>
        <button class="empty-action-btn" bindtap="navigateToEditor">åˆ›å»ºæ¨¡æ¿</button>
      </view>
    </view>

    <!-- æ¨¡æ¿åŒ…åˆ—è¡¨ -->
    <view class="package-list" wx:if="{{activeTab === 'package'}}">
      <view wx:if="{{packageGroups.length > 0}}">
        <view class="package-card" wx:for="{{packageGroups}}" wx:key="packageGroup">
          <view class="package-header">
            <view class="package-icon">ğŸ“¦</view>
            <view class="package-info">
              <text class="package-name">{{item.packageName}}</text>
              <text class="package-stats">{{item.taskCount}}ä¸ªä»»åŠ¡ Â· {{item.rewardCount}}ä¸ªå¥–åŠ±</text>
            </view>
            <view class="package-badge">å¥—è£…</view>
          </view>
          
          <view class="package-body">
            <text class="package-description">{{item.description || 'å®Œæ•´çš„ç§¯åˆ†ç®¡ç†æ–¹æ¡ˆ'}}</text>
            <view class="package-preview">
              <text class="preview-label">åŒ…å«å†…å®¹:</text>
              <view class="preview-items">
                <text class="preview-item" wx:if="{{item.taskCount > 0}}">ğŸ“‹ {{item.taskCount}}ä¸ªä»»åŠ¡æ¨¡æ¿</text>
                <text class="preview-item" wx:if="{{item.rewardCount > 0}}">ğŸ {{item.rewardCount}}ä¸ªå¥–åŠ±æ¨¡æ¿</text>
              </view>
            </view>
          </view>
          
          <view class="package-actions">
            <button class="action-btn preview-btn" bindtap="onPreviewPackage" data-package="{{item}}">
              <text class="btn-icon">ğŸ‘</text>
              <text>æŸ¥çœ‹è¯¦æƒ…</text>
            </button>
            <button class="action-btn apply-btn" bindtap="onApplyPackage" data-package="{{item}}">
              <text class="btn-icon">ğŸ“¦</text>
              <text>åº”ç”¨å¥—è£…</text>
            </button>
          </view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:else>
        <view class="empty-icon">ğŸ“¦</view>
        <text class="empty-title">æš‚æ— æ¨¡æ¿åŒ…</text>
        <text class="empty-desc">æ¨¡æ¿åŒ…åŒ…å«å¤šä¸ªç›¸å…³çš„ä»»åŠ¡å’Œå¥–åŠ±æ¨¡æ¿</text>
        <button class="empty-action-btn" bindtap="navigateToManagement">ç®¡ç†æ¨¡æ¿</button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>
</scroll-view>

<!-- æ¨¡æ¿é¢„è§ˆå¼¹çª— -->
<view class="modal-overlay" wx:if="{{showPreviewModal}}" bindtap="hidePreviewModal">
  <view class="modal-content preview-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">æ¨¡æ¿é¢„è§ˆ</text>
      <view class="modal-close" bindtap="hidePreviewModal">âœ•</view>
    </view>
    
    <view class="modal-body" wx:if="{{previewTemplate}}">
      <view class="preview-header">
        <view class="preview-icon {{previewTemplate.type === 'task' ? 'task-icon' : 'reward-icon'}}">
          {{previewTemplate.type === 'task' ? 'ğŸ“‹' : 'ğŸ'}}
        </view>
        <view class="preview-info">
          <text class="preview-name">{{previewTemplate.name}}</text>
          <text class="preview-category">{{previewTemplate.category}}</text>
        </view>
        <view class="preview-points">
          <text class="points-value">{{previewTemplate.points || previewTemplate.pointsRequired}}</text>
          <text class="points-unit">ç§¯åˆ†</text>
        </view>
      </view>
      
      <view class="preview-details">
        <view class="detail-item">
          <text class="detail-label">æè¿°</text>
          <text class="detail-value">{{previewTemplate.description}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">é€‚ç”¨å¹´é¾„</text>
          <text class="detail-value">{{getAgeGroupText(previewTemplate.ageGroup)}}</text>
        </view>
        <view class="detail-item" wx:if="{{previewTemplate.difficulty}}">
          <text class="detail-label">éš¾åº¦</text>
          <text class="detail-value">{{getDifficultyText(previewTemplate.difficulty)}}</text>
        </view>
        <view class="detail-item" wx:if="{{previewTemplate.type}}">
          <text class="detail-label">ç±»å‹</text>
          <text class="detail-value">{{getRewardTypeText(previewTemplate.type)}}</text>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="modal-btn cancel-btn" bindtap="hidePreviewModal">å…³é—­</button>
      <button class="modal-btn confirm-btn" bindtap="onApplyFromPreview">åº”ç”¨æ¨¡æ¿</button>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>