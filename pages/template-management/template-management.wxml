<!-- pages/template-management/template-management.wxml -->
<!-- æ¨¡æ¿ç®¡ç†é¡µé¢ç»“æ„ -->
<view class="container">
 

  <!-- æ¨¡å¼åˆ‡æ¢å™¨ -->
  <view class="mode-switcher">
    <view class="mode-option {{!showPackageGroups ? 'active' : ''}}" bindtap="togglePackageGroups" data-mode="template">
      <view class="mode-icon">ğŸ“‹</view>
      <text class="mode-label">æ¨¡æ¿åˆ—è¡¨</text>
      <text class="mode-desc">æŒ‰åˆ†ç±»ç­›é€‰æ¨¡æ¿</text>
    </view>
    <view class="mode-option {{showPackageGroups ? 'active' : ''}}" bindtap="togglePackageGroups" data-mode="package">
      <view class="mode-icon">ğŸ“¦</view>
      <text class="mode-label">æ¨¡æ¿åŒ…ç»„</text>
      <text class="mode-desc">æ‰¹é‡åº”ç”¨æ¨¡æ¿åŒ…</text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-bar">
    <view class="tab {{activeTab === 'task' ? 'active' : ''}}" data-tab="task" bindtap="onTabChange">
      <text class="tab-text">ä»»åŠ¡æ¨¡æ¿</text>
      <text class="tab-count" wx:if="{{!showPackageGroups}}">{{taskTemplates.length}}</text>
    </view>
    <view class="tab {{activeTab === 'reward' ? 'active' : ''}}" data-tab="reward" bindtap="onTabChange">
      <text class="tab-text">å¥–åŠ±æ¨¡æ¿</text>
      <text class="tab-count" wx:if="{{!showPackageGroups}}">{{rewardTemplates.length}}</text>
    </view>
  </view>

  <!-- åŒ…ç»„æ¨¡å¼å†…å®¹ -->
  <view class="content-area package-mode" wx:if="{{showPackageGroups && !loading}}" style="width: 679rpx; display: block; box-sizing: border-box">
    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <view style="background: #fff3cd; padding: 10rpx; margin: 10rpx; border-radius: 10rpx; font-size: 24rpx; color: #856404;" wx:if="{{packageGroups.length === 0}}">
      è°ƒè¯•ï¼šåŒ…ç»„æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
    </view>
    
    <!-- åŒ…ç»„ç½‘æ ¼ -->
    <view class="package-grid">
      <view class="package-card {{selectedPackageGroup === item.packageGroup ? 'selected' : ''}}" 
            wx:for="{{packageGroups}}" 
            wx:key="packageGroup">
        
        <!-- åŒ…ç»„å¤´éƒ¨ -->
        <view class="package-header" bindtap="onPackageGroupSelect" data-package-group="{{item.packageGroup}}">
          <view class="package-icon">ğŸ“¦</view>
          <view class="package-info">
            <text class="package-name">{{item.packageName}}</text>
            <text class="package-stats">{{item.taskCount}} ä»»åŠ¡ Â· {{item.rewardCount}} å¥–åŠ±</text>
          </view>
          <view class="package-checkbox">{{selectedPackageGroup === item.packageGroup ? 'âœ“' : ''}}</view>
        </view>
        
        <!-- åŒ…ç»„æ“ä½œ -->
        <view class="package-actions">
          <button class="package-action-btn task-btn" 
                  wx:if="{{item.taskCount > 0 && activeTab === 'task'}}"
                  bindtap="applyPackageGroupToChildren" 
                  data-package-group="{{item.packageGroup}}">
            <text class="btn-icon">ğŸ“‹</text>
            <text>åº”ç”¨ä»»åŠ¡åŒ…</text>
          </button>
          <button class="package-action-btn reward-btn" 
                  wx:if="{{item.rewardCount > 0 && activeTab === 'reward'}}"
                  bindtap="applyPackageGroupToChildren" 
                  data-package-group="{{item.packageGroup}}">
            <text class="btn-icon">ğŸ</text>
            <text>åº”ç”¨å¥–åŠ±åŒ…</text>
          </button>
        </view>
        
        <!-- åŒ…ç»„æ¨¡æ¿é¢„è§ˆ -->
        <view class="package-preview" wx:if="{{selectedPackageGroup === item.packageGroup}}">
          <text class="preview-title">åŒ…å«æ¨¡æ¿:</text>
          <view class="preview-items">
            <!-- è¿™é‡Œå¯ä»¥æ˜¾ç¤ºåŒ…ç»„å†…çš„æ¨¡æ¿åˆ—è¡¨ -->
            <text class="preview-item">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{packageGroups.length === 0}}">
      <view class="empty-icon">ğŸ“¦</view>
      <text class="empty-title">æš‚æ— æ¨¡æ¿åŒ…ç»„</text>
      <text class="empty-desc">è¯·å…ˆåˆ›å»ºæ¨¡æ¿å¹¶è®¾ç½®åŒ…ç»„ä¿¡æ¯</text>
      <button class="create-empty-btn" bindtap="onCreateTemplate">åˆ›å»ºæ¨¡æ¿</button>
    </view>
  </view>

  <!-- æ¨¡æ¿åˆ—è¡¨æ¨¡å¼å†…å®¹ -->
  <view class="content-area template-mode" wx:if="{{!showPackageGroups && !loading}}">
    <!-- ç­›é€‰æ  -->
    <view class="filter-bar">
      <view class="filter-group">
        <picker mode="selector" range="{{ageGroups}}" range-key="label" bindchange="onAgeFilterChange" value="{{ageFilterIndex}}">
          <view class="filter-btn {{ageFilter ? 'active' : ''}}">
            <text class="filter-icon">ğŸ‘¶</text>
            <text class="filter-text">{{ageFilterIndex >= 0 ? ageGroups[ageFilterIndex].label : 'å¹´é¾„æ®µ'}}</text>
            <text class="filter-arrow">â–¼</text>
          </view>
        </picker>
        
        <picker mode="selector" range="{{categories}}" range-key="label" bindchange="onCategoryFilterChange" value="{{categoryFilterIndex}}">
          <view class="filter-btn {{categoryFilter ? 'active' : ''}}">
            <text class="filter-icon">ğŸ“‚</text>
            <text class="filter-text">{{categoryFilterIndex >= 0 ? categories[categoryFilterIndex].label : 'åˆ†ç±»'}}</text>
            <text class="filter-arrow">â–¼</text>
          </view>
        </picker>
        
        <button class="filter-btn clear-btn" bindtap="clearFilters" wx:if="{{ageFilter || categoryFilter}}">
          <text class="filter-icon">ğŸ—‘ï¸</text>
          <text class="filter-text">æ¸…é™¤</text>
        </button>
      </view>
    </view>
    
    <!-- æ¨¡æ¿ç½‘æ ¼ -->
    <view class="template-grid">
      <!-- ä»»åŠ¡æ¨¡æ¿åˆ—è¡¨ -->
      <view wx:if="{{activeTab === 'task'}}">
        <view wx:if="{{taskTemplates.length > 0}}">
          <view class="template-card" wx:for="{{taskTemplates}}" wx:key="_id">
            <view class="template-card-header">
              <view class="template-type-icon">ğŸ“‹</view>
              <view class="template-title-area">
                <text class="template-name">{{item.name}}</text>
                <view class="template-badges">
                  <text class="badge points">{{item.points}}ç§¯åˆ†</text>
                  <text class="badge age">{{getAgeGroupLabel(item.ageGroup)}}</text>
                  <text class="badge category">{{getCategoryLabel(item.category)}}</text>
                </view>
              </view>
              <view class="template-status {{item.isActive ? 'active' : 'inactive'}}">
                {{item.isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}}
              </view>
            </view>
            
            <view class="template-card-body">
              <text class="template-desc">{{item.description}}</text>
              <view class="template-package" wx:if="{{item.isInPackage}}">
                <text class="package-tag">ğŸ“¦ {{item.packageName}}</text>
              </view>
            </view>
            
            <view class="template-card-actions">
              <button class="card-btn primary-btn" bindtap="showChildSelectorModal" data-template="{{item}}">
                <text class="btn-icon">âœ“</text>
                <text>åº”ç”¨</text>
              </button>
              <button class="card-btn secondary-btn" bindtap="onViewTemplate" data-template="{{item}}">
                <text class="btn-icon">ğŸ‘</text>
                <text>è¯¦æƒ…</text>
              </button>
              <button class="card-btn edit-btn" bindtap="onEditTemplate" data-template="{{item}}">
                <text class="btn-icon">âœï¸</text>
                <text>ç¼–è¾‘</text>
              </button>
            </view>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:else>
          <view class="empty-icon">ğŸ“‹</view>
          <text class="empty-title">æš‚æ— ä»»åŠ¡æ¨¡æ¿</text>
          <text class="empty-desc">åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡æ¨¡æ¿æ¥å¼€å§‹ç®¡ç†</text>
          <button class="create-empty-btn" bindtap="onCreateTemplate">åˆ›å»ºä»»åŠ¡æ¨¡æ¿</button>
        </view>
      </view>
      
      <!-- å¥–åŠ±æ¨¡æ¿åˆ—è¡¨ -->
      <view wx:if="{{activeTab === 'reward'}}">
        <view wx:if="{{rewardTemplates.length > 0}}">
          <view class="template-card" wx:for="{{rewardTemplates}}" wx:key="_id">
            <view class="template-card-header">
              <view class="template-type-icon">ğŸ</view>
              <view class="template-title-area">
                <text class="template-name">{{item.name}}</text>
                <view class="template-badges">
                  <text class="badge points">{{item.pointsRequired}}ç§¯åˆ†</text>
                  <text class="badge age">{{getAgeGroupLabel(item.ageGroup)}}</text>
                  <text class="badge category">{{getCategoryLabel(item.category)}}</text>
                </view>
              </view>
              <view class="template-status {{item.isActive ? 'active' : 'inactive'}}">
                {{item.isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}}
              </view>
            </view>
            
            <view class="template-card-body">
              <text class="template-desc">{{item.description}}</text>
              <view class="template-package" wx:if="{{item.isInPackage}}">
                <text class="package-tag">ğŸ“¦ {{item.packageName}}</text>
              </view>
            </view>
            
            <view class="template-card-actions">
              <button class="card-btn primary-btn" bindtap="showChildSelectorModal" data-template="{{item}}">
                <text class="btn-icon">âœ“</text>
                <text>åº”ç”¨</text>
              </button>
              <button class="card-btn secondary-btn" bindtap="onViewTemplate" data-template="{{item}}">
                <text class="btn-icon">ğŸ‘</text>
                <text>è¯¦æƒ…</text>
              </button>
              <button class="card-btn edit-btn" bindtap="onEditTemplate" data-template="{{item}}">
                <text class="btn-icon">âœï¸</text>
                <text>ç¼–è¾‘</text>
              </button>
            </view>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:else>
          <view class="empty-icon">ğŸ</view>
          <text class="empty-title">æš‚æ— å¥–åŠ±æ¨¡æ¿</text>
          <text class="empty-desc">åˆ›å»ºç¬¬ä¸€ä¸ªå¥–åŠ±æ¨¡æ¿æ¥æ¿€åŠ±å­©å­</text>
          <button class="create-empty-btn" bindtap="onCreateTemplate">åˆ›å»ºå¥–åŠ±æ¨¡æ¿</button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æ‚¬æµ®åˆ›å»ºæŒ‰é’® -->
  <view class="floating-add-btn" bindtap="onCreateTemplate" wx:if="{{!loading}}">
    <text class="add-icon">+</text>
  </view>
</view>

<!-- å„¿ç«¥é€‰æ‹©å™¨å¼¹çª— -->
<view class="modal-mask" wx:if="{{showChildSelector}}" bindtap="hideChildSelectorModal"></view>
<view class="modal-container" wx:if="{{showChildSelector}}">
  <view class="modal-header">
    <text class="modal-title">é€‰æ‹©åº”ç”¨å„¿ç«¥</text>
    <text class="modal-close" bindtap="hideChildSelectorModal">Ã—</text>
  </view>
  
  <view class="modal-content">
    <!-- æ¨¡æ¿ä¿¡æ¯é¢„è§ˆ -->
    <view class="template-preview">
      <text class="preview-title">æ¨¡æ¿ä¿¡æ¯</text>
      <view class="preview-info">
        <text class="preview-name">{{currentTemplate.packageName || currentTemplate.name || 'æ¨¡æ¿'}}</text>
        <text class="preview-desc">{{currentTemplate.description || 'æš‚æ— æè¿°'}}</text>
        <view class="preview-type" wx:if="{{currentTemplate.packageGroup}}">
          <text class="type-badge">åŒ…ç»„æ¨¡æ¿</text>
          <text class="type-detail" wx:if="{{currentTemplate.templateType === 'task'}}">
            {{currentTemplate.taskCount || 0}} ä¸ªä»»åŠ¡æ¨¡æ¿
          </text>
          <text class="type-detail" wx:elif="{{currentTemplate.templateType === 'reward'}}">
            {{currentTemplate.rewardCount || 0}} ä¸ªå¥–åŠ±æ¨¡æ¿
          </text>
          <text class="type-detail" wx:else>
            {{currentTemplate.taskCount || 0}} ä»»åŠ¡ Â· {{currentTemplate.rewardCount || 0}} å¥–åŠ±
          </text>
        </view>
      </view>
    </view>
    
    <!-- å„¿ç«¥é€‰æ‹©åŒºåŸŸ -->
    <view class="child-selector">
      <view class="selector-header">
        <text class="selector-title">é€‰æ‹©å„¿ç«¥</text>
        <button class="select-all-btn" bindtap="onToggleSelectAll" disabled="{{children.length === 0}}">
          {{selectedChildren.length === children.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
        </button>
      </view>
      
      <!-- ä½¿ç”¨æ ‡å‡†çš„ checkbox-group ç»„ä»¶ - ä¼˜åŒ–æ€§èƒ½ç‰ˆæœ¬ -->
      <checkbox-group bindchange="onCheckboxChange" class="child-checkbox-group">
        <view class="child-list">
          <label class="child-item" wx:for="{{children}}" wx:key="_id" wx:for-item="child">
            <checkbox value="{{child._id}}" checked="{{childSelectionMap[child._id] || false}}" class="child-checkbox"/>
            <view class="child-info">
              <text class="child-name">{{child.name}}</text>
              <text class="child-age">{{child.age}}å²</text>
            </view>
          </label>
          
          <view class="empty-children" wx:if="{{children.length === 0}}">
            <text>æš‚æ— å„¿ç«¥ï¼Œè¯·å…ˆæ·»åŠ å„¿ç«¥</text>
            <button class="add-child-btn" bindtap="goToAddChild">æ·»åŠ å„¿ç«¥</button>
          </view>
        </view>
      </checkbox-group>
      
      <!-- é€‰æ‹©çš„å„¿ç«¥æ•°é‡æ˜¾ç¤º -->
      <view class="selection-summary" wx:if="{{selectedChildren.length > 0}}">
        <text class="summary-text">å·²é€‰æ‹© {{selectedChildren.length}} ä¸ªå„¿ç«¥</text>
        <view class="selected-names">
          <text class="selected-name" wx:for="{{getSelectedChildrenNames()}}" wx:key="*this">{{item}}</text>
        </view>
      </view>
    </view>
  </view>
  
  <view class="modal-footer">
    <button class="cancel-btn" bindtap="hideChildSelectorModal">å–æ¶ˆ</button>
    <button class="confirm-btn" bindtap="applyTemplateToChildren" disabled="{{loading || selectedChildren.length === 0}}">
      <text wx:if="{{currentTemplate.packageGroup}}">åº”ç”¨{{currentTemplate.templateType === 'task' ? 'ä»»åŠ¡åŒ…' : 'å¥–åŠ±åŒ…'}}</text>
      <text wx:else>åº”ç”¨æ¨¡æ¿</text>
      åˆ°{{selectedChildren.length}}ä¸ªå„¿ç«¥
    </button>
  </view>
</view>